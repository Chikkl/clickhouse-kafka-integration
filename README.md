# ClickHouse + Kafka: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤–∏—Ç—Ä–∏–Ω—ã –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏ **ClickHouse: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Apache Kafka**.  

–¶–µ–ª—å: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–∞–π–ø–ª–∞–π–Ω** –æ—Ç –ø–æ—Ç–æ–∫–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ Kafka –¥–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π **–≤–∏—Ç—Ä–∏–Ω—ã –¥–∞–Ω–Ω—ã—Ö** –≤ ClickHouse —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **–º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π**.

---

## üéØ –ó–∞–¥–∞—á–∏

1. **–ß—Ç–µ–Ω–∏–µ –∏–∑ Kafka**  
   –ù–∞—Å—Ç—Ä–æ–π—Ç–µ ClickHouse –Ω–∞ –ø—Ä–∏—ë–º —Å–æ–±—ã—Ç–∏–π –∏–∑ Kafka-—Ç–æ–ø–∏–∫–∞ `user_events` –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.

2. **–°–æ–∑–¥–∞–Ω–∏–µ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö**  
   –ü–æ—Å—Ç—Ä–æ–π—Ç–µ —Ç—Ä–∏ —Å–ª–æ—è:
   - **Raw (—Å—ã—Ä–æ–π)** ‚Äî –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Kafka.
   - **Clean (–æ—á–∏—â–µ–Ω–Ω—ã–π)** ‚Äî –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –ø—Ä–∏–≤–µ–¥—ë–Ω–Ω—ã–µ –∫ —Ç–∏–ø–∞–º –∑–∞–ø–∏—Å–∏.
   - **Mart (–≤–∏—Ç—Ä–∏–Ω–∞)** ‚Äî –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–Ω–µ–≤–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π).

3. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è**  
   –í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å–ª–æ—è–º–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –±–µ–∑ —Ä—É—á–Ω—ã—Ö `INSERT`.

4. **–ó–∞–ø–∏—Å—å –≤ Kafka –∏–∑ ClickHouse**  
   –†–µ–∞–ª–∏–∑—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö **–∏–∑ ClickHouse –æ–±—Ä–∞—Ç–Ω–æ –≤ Kafka**:
   - –°–æ–∑–¥–∞–π—Ç–µ Kafka-—Ç–æ–ø–∏–∫ `alerts` (–∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π).
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤ ClickHouse —Å –¥–≤–∏–∂–∫–æ–º `Kafka`, –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—É—é –∫ —ç—Ç–æ–º—É —Ç–æ–ø–∏–∫—É.
   - –°–æ–∑–¥–∞–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∞–Ω–æ–º–∞–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, >10 —Å–æ–±—ã—Ç–∏–π –∑–∞ –º–∏–Ω—É—Ç—É –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–ª–µ—Ä—Ç –≤ `alerts`.
   - –§–æ—Ä–º–∞—Ç –∞–ª–µ—Ä—Ç–∞ ‚Äî JSON:

     ```json
     {
       "alert_type": "high_activity",
       "user_id": "user_42",
       "event_count": 15,
       "window_start": "2025-11-26T12:00:00Z",
       "detected_at": "2025-11-26T12:01:00Z"
     }
     ```

---

## üß™ –§–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ö–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤ Kafka ‚Äî —ç—Ç–æ JSON-–æ–±—ä–µ–∫—Ç:

```json
{
  "event_id": "12345",
  "user_id": "alice",
  "timestamp": "2025-11-26T10:00:00Z"
}
```

---

## üìÅ –ß—Ç–æ —Å–¥–∞–≤–∞—Ç—å

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `solution.sql` –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –ø–æ–º–µ—Å—Ç–∏—Ç–µ –≤ –Ω–µ–≥–æ:

- –í—Å–µ `CREATE TABLE` (–≤–∫–ª—é—á–∞—è Kafka-–¥–≤–∏–∂–∫–∏).
- –í—Å–µ `CREATE MATERIALIZED VIEW`.
- `CREATE TABLE` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ Kafka.

> ‚ö†Ô∏è –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω—ã–µ `INSERT`. –î–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—É–ø–∞—é—Ç —Ç–æ–ª—å–∫–æ –∏–∑ Kafka.

---

## üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å—Ç–µ–Ω–¥–∞

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã **Docker** –∏ **Docker Compose**.
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É:

   ```bash
   docker compose up --build
   ```

3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ Kafka:

   ```bash
   echo '{"event_id":"1","user_id":"user_a","timestamp":"2025-11-26T12:00:00Z"}' | \
     docker exec -i kafka-broker /opt/kafka/bin/kafka-console-producer.sh \
       --bootstrap-server localhost:9092 --topic user_events
   ```

4. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ ClickHouse:

   ```bash
   docker exec -it clickhouse-srv-local clickhouse-client --password default
   ```

5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:

   ```sql
   SELECT * FROM events_raw;
   SELECT * FROM events_clean;
   SELECT * FROM user_daily_activity;
   ```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å–æ–±—ã—Ç–∏–π

–î–ª—è —É–¥–æ–±–Ω–æ–π –∏ –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞—à–µ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π:

```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç–µ–∫ –∑–∞–ø—É—â–µ–Ω
docker compose up --build -d

# –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø–∞–ø–∫—É —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ
cd scripts
python generate_events.py
```

–°–∫—Ä–∏–ø—Ç:

1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 100 —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –æ–ø–∏—Å–∞–Ω–Ω–æ–º –≤—ã—à–µ.
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ Kafka-—Ç–æ–ø–∏–∫ user_events.
3. –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö –≤ events_raw.
    - –†–∞–±–æ—Ç—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ events_clean.
    - –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –≤–∏—Ç—Ä–∏–Ω—ã user_daily_activity.
    - –ì–µ–Ω–µ—Ä–∞—Ü–∏—é –∞–ª–µ—Ä—Ç–æ–≤ (–µ—Å–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ alerts).

(—É–∫–∞–∑–∞–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü, –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –∏ –±–æ–ª—å—à–µ–π —è—Å–Ω–æ—Å—Ç–∏)

## üåê –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

- **ClickHouse Playground**: [http://localhost:8123/play](http://localhost:8123/play)  
- **Kafka Console (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–ø–∏–∫–æ–≤)**: [http://localhost:8080](http://localhost:8080)

---

–£–¥–∞—á–∏! –í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ClickHouse —Å Kafka.

---

‚úÖ **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `docker-compose.yml`**:

1. –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É `init` –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
2. –ü–æ–ª–æ–∂–∏—Ç–µ —Ç—É–¥–∞ `solution.sql` ‚Äî –æ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ ClickHouse.
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ `docker compose up --build`.
4. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ, –æ—Ç–ø—Ä–∞–≤–ª—è—è —Å–æ–±—ã—Ç–∏—è –≤ Kafka.
