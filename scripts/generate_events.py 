"""
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
{
  "event_id": "<int>",
  "user_id": "user_<N>",
  "timestamp": "YYYY-MM-DDTHH:MM:SSZ"
}

–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ Kafka-—Ç–æ–ø–∏–∫ 'user_events' —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π producer.
–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä kafka-broker –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ `docker exec`.
"""

import json
import random
import subprocess
import time
from datetime import datetime, timedelta

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
TOPIC = "user_events"
NUM_EVENTS = 500
DELAY_SEC = 0.25  # –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Å–æ–±—ã—Ç–∏—è–º–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏

def generate_event():
    event_id = random.randint(1, 1_000_000)
    user_id = f"user_{random.randint(1, 100)}"
    # —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
    now = datetime.utcnow()
    rand_time = now - timedelta(days=random.randint(0, 7), 
                                hours=random.randint(0, 23),
                                minutes=random.randint(0, 59))
    timestamp = rand_time.strftime("%Y-%m-%dT%H:%M:%SZ")

    return {
        "event_id": str(event_id),
        "user_id": user_id,
        "timestamp": timestamp
    }

def send_to_kafka(event):
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º docker exec –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä kafka-broker
    cmd = [
        "docker", "exec", "-i", "kafka-broker",
        "/opt/kafka/bin/kafka-console-producer.sh",
        "--bootstrap-server", "localhost:9092",
        "--topic", TOPIC
    ]
    proc = subprocess.Popen(cmd, stdin=subprocess.PIPE, text=True)
    proc.stdin.write(json.dumps(event) + "\n")
    proc.stdin.close()
    proc.wait()

def main():
    print(f"üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ {NUM_EVENTS} —Å–æ–±—ã—Ç–∏–π –≤ —Ç–æ–ø–∏–∫ '{TOPIC}'...")
    for i in range(NUM_EVENTS):
        event = generate_event()
        send_to_kafka(event)
        print(f"[{i+1}] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {event}")
        time.sleep(DELAY_SEC)
    print("‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")

if __name__ == "__main__":
    main()